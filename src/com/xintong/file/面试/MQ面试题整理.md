# MQ面试题

##### 1 *消息去重（重复消费）（消息消费幂等性）

我先说可能产生重复的场景

1. 可靠消息最终一致性分布式事务解决方案中，如果这边没得到ack，会不断的检测该消息的状态是否到达finish状态，若没到他会认为消息丢失或者对方处理失败，进行重发，这个时候就可能造成消息重复
2. 就拿kafka来说，有一个offset的概念，消费者会告诉提供者自己消费到哪个offset了，但并不是每一次都告诉，而是定时定期去提交，如果因为网络或者其他什么问题造成这个提交出了问题，提供者会继续重复发送该消息，也会造成消息重复

##### 2 *消息丢失

原因 RabbitMQ

1. 可能生产者发了消息，消息还没到RabbitMQ，就已经在网络传输过程中丢了    
   - 基于confirm模式发送消息，等待ack回调通知成功还是失败
2. 可能rabbitmq在接收到消息后在内存中还没来得及消费，挂掉了，这样重启之后就丢了
   - 消息持久化
3. 消费者接收到消息还没来得及处理，自己挂掉了



原因 Kafka

1. 消费端弄丢数据

   Kafka有offset的概念，比如消费者刚开始消费消息，然后消费者自动提交了offset，但是消费者突然又挂了，这个时候kafka知道你已经消费了消息，其实并没有消费，这样一来这个消息就丢失了

   - 解决：关闭自动提交消息，自己处理完消息之后手动提交offset，这样就可以保证消费者这边不会出现消息丢失，但是万一你处理完消息还没提交offset自己就挂了，重启之后必然存在重复消费的问题，自己处理好幂等性就行了

2. Kafka broker丢失消息 

   比如一个Leader 两个follower，Leader接收到消息还没来得及同步给follower自己就挂了，那么重选出了的Leader肯定是不知道这条消息的存在的

   Kafka 有一个 product端设置acks=all的配置还是什么来的，意思是生产者发送消息到集群，集群同步完成之后，才算消息发送成功，这样就可以保证broker不会丢失消息

   product端设置retries = MAX 不断重试直至消息发送成功

3. 生产者丢数据

   

##### 3 *消息异常

##### 4

